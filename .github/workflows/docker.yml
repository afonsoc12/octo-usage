name: Docker

concurrency: Docker

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  ci:
    name: CI
    uses: ./.github/workflows/ci.yml

  build:
    name: ðŸ³ Build & Push Docker Image
    needs: ci
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v6

      - name: ðŸ“– Extract version from pyproject.toml
        id: version
        run: |
          VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Build number: ${{ github.run_number }}"

      - name: ðŸ·ï¸ Determine tags
        id: tags
        run: |
          VERSION=${{ steps.version.outputs.version }}
          BUILD_NUM=${{ github.run_number }}
          STABLE="${VERSION}"
          BUILD="${VERSION}-b${BUILD_NUM}"
          
          echo "version=$STABLE" >> $GITHUB_OUTPUT
          echo "build=$BUILD" >> $GITHUB_OUTPUT
          echo "Version tag: $STABLE"
          echo "Build tag: $BUILD"

      - name: ðŸ”§ Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: ðŸ”¨ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ³ Build and push
        uses: docker/build-push-action@v5
        id: build
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/afonsoc12/octo-usage:${{ steps.tags.outputs.version }}
            ghcr.io/afonsoc12/octo-usage:${{ steps.tags.outputs.build }}
            ghcr.io/afonsoc12/octo-usage:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ“Š Get image digest
        id: image
        run: |
          echo "digest=${{ steps.build.outputs.digest }}" >> $GITHUB_OUTPUT

      - name: ðŸ“ Job summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ³ Docker Build Summary
          
          ## Build Information
          - **Status**: âœ… Success
          - **Build Number**: ${{ github.run_number }}
          - **Branch**: ${{ github.ref_name }}
          - **Commit SHA**: ${{ github.sha }}
          - **Actor**: ${{ github.actor }}
          
          ## Image Details
          - **Registry**: ghcr.io
          - **Repository**: afonsoc12/octo-usage
          - **Platforms**: linux/amd64, linux/arm64
          - **Image Digest**: `${{ steps.image.outputs.digest }}`
          
          ## Tags
          - **Version**: `ghcr.io/afonsoc12/octo-usage:${{ steps.tags.outputs.version }}`
          - **Build**: `ghcr.io/afonsoc12/octo-usage:${{ steps.tags.outputs.build }}`
          - **Latest**: `ghcr.io/afonsoc12/octo-usage:latest`
          
          ## Pull Commands
          ```bash
          # Pull version
          docker pull ghcr.io/afonsoc12/octo-usage:${{ steps.tags.outputs.version }}
          
          # Pull specific build
          docker pull ghcr.io/afonsoc12/octo-usage:${{ steps.tags.outputs.build }}
          
          # Pull latest
          docker pull ghcr.io/afonsoc12/octo-usage:latest
          ```
          
          ## Timestamps
          - **Built**: ${{ github.event.head_commit.timestamp }}
          - **Job Runtime**: ${{ job.duration }}s
          EOF
